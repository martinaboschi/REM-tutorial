#knitr::knit_hooks$set(purl = knitr:hook_purl)
knitr::opts_chunk$set(echo = TRUE)
load("/Users/edoardofilippi-mazzola/Library/CloudStorage/Dropbox/Sunbelt_2024/04-GitHub-Repository/REM-tutorial/01-REM2point0/01-Introduction_to_REMS_1point0/00-Data/class.RData")
#knitr::knit_hooks$set(purl = knitr:hook_purl)
knitr::opts_chunk$set(echo = TRUE)
set.seed(2972)
#number of individuals
p<-5
#interest in cars
WE<-c(0,3,5,9,11)
if (length(WE)!=p){stop()}
needed<-2
#collected letters so far
n.letters<-rep(0,p)
#risk set
riskset<-cbind(rep(1:p,each=p),rep(1:p,p))
riskset<-riskset[riskset[,1]!=riskset[,2],]
# dat
dat<-NULL
tm<-0
while (min(n.letters)<needed){
#hazard
hazard<- exp(-1.5*abs(WE[riskset[,1]]-WE[riskset[,2]]))
#sample new event time
tm<-tm+rexp(1,sum(hazard))
event.id<-sample(length(hazard),1, prob=hazard/sum(hazard))
dat<-rbind(dat,c(tm,riskset[event.id,]))
#update number of reference letters
n.letters[riskset[event.id,1]]<-n.letters[riskset[event.id,1]]+1
if (n.letters[riskset[event.id,1]]==needed){
riskset<-riskset[riskset[,1]!=riskset[event.id,1],]
} else {
riskset<-riskset[-event.id,]
}
}
colnames(dat)<-c("tm","solicitor","receiver")
dat
require(igraph)
library(igraph)
g<-graph_from_edgelist(dat[,2:3])
plot(g)
n.event <- nrow(dat)
V <- sort(unique(c(dat[,2:3])))
p <- length(V)
#collected letters so far
n.letters<-rep(0,p)
#risk set
riskset<-cbind(rep(V,each=p),rep(V,p))
riskset<-riskset[riskset[,1]!=riskset[,2],]
#sampled data
sampled.dat <- NULL
for (i in 1:n.event){
event.id<- which((riskset[,1]==dat[i,2])&(riskset[,2]==dat[i,3]))
non.event.id<-sample(setdiff(1:nrow(riskset),event.id),1)
sampled.dat<-rbind(sampled.dat,c(dat[i,],riskset[non.event.id,]))
#update number of reference letters
n.letters[riskset[event.id,1]]<-n.letters[riskset[event.id,1]]+1
if (n.letters[riskset[event.id,1]]==needed){
riskset<-riskset[riskset[,1]!=riskset[event.id,1],]
} else {
riskset<-riskset[-event.id,]
}
}
colnames(sampled.dat)<-c("tm","solicitor","receiver","non.solicitor","non.receiver")
sampled.dat
WE.diff<-abs(WE[sampled.dat[,2]]-WE[sampled.dat[,3]]) - abs(WE[sampled.dat[,4]]-WE[sampled.dat[,5]])
one<-rep(1,length(WE.diff))
full.dat<-cbind(sampled.dat,WE.diff,one)
colnames(full.dat)<-c("tm","solicitor","receiver","non.solicitor","non.receiver","WE.diff","one")
full.dat<-as.data.frame(full.dat)
full.dat
load("00-Data/class.RData")
head(class$rev)
class$info
# Riskset
p<-length(class$info$male)
riskset<-cbind(rep(1:p,p),rep(1:p,each=p))
riskset
riskset<-riskset[riskset[,1]!=riskset[,2],]
riskset<-cbind(riskset,1:nrow(riskset))
colnames(riskset)<-c("sender","receiver","id")
riskset
class
len(class$info$male)
length(class$info$male)
# Riskset
p<-length(class$info$male)
riskset<-cbind(rep(1:p,p),rep(1:p,each=p))
riskset<-riskset[riskset[,1]!=riskset[,2],]
riskset<-cbind(riskset,1:nrow(riskset))
colnames(riskset)<-c("sender","receiver","id")
# Sample non-events
set.seed(1)
n<-nrow(class$rev)
non.events<-NULL
for (i in 1:n){
snd<-class$rev[i,1]
rcv<-class$rev[i,1]
non.id<-sample(riskset[riskset[,1]!=snd | riskset[,2]!=rcv,3],1)
non.snd<-riskset[non.id,1]
non.rcv<-riskset[non.id,2]
non.events<-rbind(non.events,c(non.snd,non.rcv))
}
colnames(non.events)<-c("non.sender","non.receiver")
class$rev<-cbind(class$rev,non.events)
# Riskset
p<-length(class$info$male)
riskset<-cbind(rep(1:p,p),rep(1:p,each=p))
riskset<-riskset[riskset[,1]!=riskset[,2],]
riskset<-cbind(riskset,1:nrow(riskset))
colnames(riskset)<-c("sender","receiver","id")
# Sample non-events
set.seed(1)
n<-nrow(class$rev)
non.events<-NULL
for (i in 1:n){
snd<-class$rev[i,1]
rcv<-class$rev[i,1]
non.id<-sample(riskset[riskset[,1]!=snd | riskset[,2]!=rcv,3],1)
non.snd<-riskset[non.id,1]
non.rcv<-riskset[non.id,2]
non.events<-rbind(non.events,c(non.snd,non.rcv))
}
colnames(non.events)<-c("non.sender","non.receiver")
class$rev<-cbind(class$rev,non.events)
sender.gender <- class$info$male[class$rev$sender] - class$info$male[class$rev$non.sender]
receiver.gender <- class$info$male[class$rev$receiver] - class$info$male[class$rev$non.receiver]
same.gender <- (class$info$male[class$rev$sender] == class$info$male[class$rev$receiver]) -
(class$info$male[class$rev$non.sender] == class$info$male[class$rev$non.receiver])
class$rev <- cbind(class$rev,sender.gender,receiver.gender,same.gender)
sender.gender <- class$info$male[class$rev$sender] - class$info$male[class$rev$non.sender]
receiver.gender <- class$info$male[class$rev$receiver] - class$info$male[class$rev$non.receiver]
same.gender <- (class$info$male[class$rev$sender] == class$info$male[class$rev$receiver]) -
(class$info$male[class$rev$non.sender] == class$info$male[class$rev$non.receiver])
class$rev <- cbind(class$rev,sender.gender,receiver.gender,same.gender)
library(mgcv)
one<-rep(1,n)
class$rev<- cbind(class$rev,one)
class1.glm <- gam(one~-1+sender.gender+receiver.gender+same.gender, family = binomial,
data=class$rev)
summary(class1.glm)
tms <- class$rev$time
Lambda0<-NULL
absR<-nrow(riskset)
event.x<-cbind(class$info$male[class$rev$sender], class$info$male[class$rev$receiver],
1*(class$info$male[class$rev$sender]==class$info$male[class$rev$receiver]))
non.event.x<-cbind(class$info$male[class$rev$non.sender], class$info$male[class$rev$non.receiver],
1*(class$info$male[class$rev$non.sender]==class$info$male[class$rev$non.receiver]))
bhat<-coef(class1.glm)
Lambda0<-2/absR*cumsum(1/(exp(event.x%*%bhat)+exp(non.event.x%*%bhat)))
plot(tms,Lambda0,type="l",xlab="Time (minutes)", ylab=expression(Lambda[0]),
main="Estimated Baseline Hazard")
